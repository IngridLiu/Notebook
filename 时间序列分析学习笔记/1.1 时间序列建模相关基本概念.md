# 1. 时间序列建模基础

<br>
<br>

&emsp;&emsp;时间序列（或称动态数列）是指将同一统计指标的数值按其发生的时间先后顺序排列而成的数列。时间序列分析的主要目的是根据已有的历史数据对未来进行预测。

## 1. 时间序列特点

&emsp;&emsp;研究序列过去的行为有助于辨别其中的模式从而作出更好的预测。将其绘制成图时，许多时间序列就会表现出下列一种或多种特征：

&emsp;&emsp; - 趋势

&emsp;&emsp; - 季节周期和非季节周期

&emsp;&emsp; - 脉冲和步进

&emsp;&emsp; - 界外值

### 1.1 趋势

&emsp;&emsp; 趋势是指序列水平的逐渐上升或下降或序列值随时间的推移而增大或减小的趋势。

![](https://www.ibm.com/support/knowledgecenter/zh/SS3RA7_sub/modeler_mainhelp_client_ddita/components/images/trend01.jpg)

&emsp;&emsp; 趋势既可以是局部的，也可以是全局的，而一个序列可以同时体现这两种趋势。从历史记录来看，股票市场指数的序列图总的趋势是上升的。经济萧条时期所表现出的是局部下降趋势，而经济繁荣时期表现出的是局部上升趋势。

&emsp;&emsp; 趋势既可以是线性的，也可以是非线性的。线性趋势是指序列水平表现为正增加或负增加，就和本金以单利计息差不多。非线性趋势通常表现为倍增，即相对于以前的序列值成比例地增长。

&emsp;&emsp; 全局线性趋势可通过指数平滑模型和 ARIMA 模型很好地拟合和预测。在构建 ARIMA 模型的过程中，通常会对表现出趋势的序列进行区分，以消除趋势的影响。

### 1.2 季节周期和非季节周期

#### 1.2.1 季节性周期

&emsp;&emsp;季节性周期 是序列值中可预测的重复模式。

![](https://www.ibm.com/support/knowledgecenter/zh/SS3RA7_sub/modeler_mainhelp_client_ddita/components/images/season.jpg)

&emsp;&emsp;季节性周期与序列的时间间隔相联系。例如，月度数据通常会随季度和年度而循环。月度序列可能会表现出第一个季度较低的明显季度周期或每年十二月份都出现峰值的年度周期。表现出季节性周期的序列称之为具有季节性。

&emsp;&emsp;季节模式对于获取良好的拟合和预测非常有用，用来捕获季节性的有指数平滑模型和 ARIMA 模型。

#### 1.2.2 非季节性周期

&emsp;&emsp;非季节性周期是序列值中可能无法预测的重复模式。

![](https://www.ibm.com/support/knowledgecenter/zh/SS3RA7_sub/modeler_mainhelp_client_ddita/components/images/cycle.jpg)

&emsp;&emsp;某些序列（如失业率）明显地表现出周期性行为；但这种周期性的周期会随时间而变化，因此很难预测何时高何时低。其他序列可能具有可预测的周期，但可能与阳历并不完全吻合，或者其周期比一年长。例如，潮汐遵循阴历，与奥林匹克运动会相关的国际旅游和贸易每隔四年膨胀一次，还有许多宗教节日，其阳历日期每年都会变化。

&emsp;&emsp;非季节周期模式很难建模，通常会增加预测的不确定性。例如，股票市场的许多序列实例就常使预测者的努力无功而返。即便如此，当存在非季节模式时，还是有必要加以说明。在许多情况下，您仍然可以找出与历史数据拟合得很好的模型，从而最大限度地减小预测中的不确定性。

## 1.3 脉冲和步进

&emsp;&emsp; 许多序列都会出现水平突变。它们通常分为两种类型：

&emsp;&emsp; - 序列水平突然、 临时性的变动，或称 脉冲

&emsp;&emsp; - 序列水平突然、 永久性的变动，或称 步进

![](https://www.ibm.com/support/knowledgecenter/zh/SS3RA7_sub/modeler_mainhelp_client_ddita/components/images/pulse.jpg)

&emsp;&emsp; 观测到步进或脉冲时，找到一种貌似合理的解释很重要。时间序列模型是用来说明渐变而非突变的。因此，它们往往低估脉冲并为步进所瓦解，导致模型拟合差强人意，增加预测的不确定性。（某些季节性实例可能表现为突然的水平变化，但该水平在不同的季节周期之间则保持稳定。）

&emsp;&emsp; 如果扰动是可以解释的，那么可以使用 干预 或 事件 为其建模。例如，1973 年 8 月，石油输出国组织 (OPEC) 颁布的石油禁运导致了通货膨胀率的急剧变化，经过数月之后才恢复到正常水平。通过为该禁运月指定一个 点干预 ，可以改善模型的拟合度，因此可以间接提高预测的准确性。例如，某个零售店可能会发现，所有商品均标记降价 50% 的当天销售量比平时高出很多。通过将降价 50% 的促销指定为一个定期的 事件 ，可以改善模型的拟合度，估计将来重复该项促销措施的影响。

## 1.4 界外值

&emsp;&emsp; 时间序列水平中无法解释的变动称为 离群值 。这些观测值与序列中的其他值不一致，可能会显著影响分析，从而影响时间序列模型的预测能力。

&emsp;&emsp; 下图显示了时间序列中常见的几种离群值。蓝线表示没有离群值的序列。红线表示如果序列包含离群值情况下可能存在的模式。这些离群值全部归为 确定性 离群值，因为它们只影响序列的均值水平。

![](https://www.ibm.com/support/knowledgecenter/zh/SS3RA7_sub/modeler_mainhelp_client_ddita/clementine/images/tsoutliers.jpg)

&emsp;&emsp; **加性离群值。** 加性离群值表现为一次观测中出现的异常大或异常小的值。后续观测不受加性离群值的影响。连续的加性离群值通常称为加法离群值修补。

&emsp;&emsp; **创新离群值。** 创新离群值的特征为初始影响一直对后续观测产生作用。这些离群值的影响可能会随着时间的推移而不断增强。

&emsp;&emsp; **水平变动离群值。** 对于水平变动，离群值之后出现的所有观测值均移动到新水平。与加性离群值相反，水平变动离群值会影响许多观测值，并且具有永久性影响。

&emsp;&emsp; **瞬时变化离群值。** 瞬时变化离群值类似水平变动离群值，只是这种离群值对后续观测的影响呈指数递减。最终，该序列会恢复到正常水平。

&emsp;&emsp; **季节加性离群值。** 季节加性离群值表现为以固定时间间隔重复出现的异常大或异常小的值。

&emsp;&emsp; **局部趋势离群值。** 局部趋势离群值会在出现初始离群值之后，在序列中产生一个由离群值中的模式所导致的整体漂移。

&emsp;&emsp; 时间序列中的离群值检测包括确定存在的任何离群值的位置、类型和大小。Tsay (1988) 提出了一个用于检测均值水平变化以识别出确定性离群值的迭代过程。此过程是将一个假设不存在离群值的时间序列模型与另一个具有离群值的模型进行比较。从两个模型之间的差异得到将任何给定点视为离群值的影响的估计。

<br>

## 2. 序列变换

&emsp;&emsp; 变换对在模型估计之前稳定序列常常有用。这对 ARIMA 模型尤其重要，因为估计这类模型之前需要序列保持 稳定 。如果在整个序列中，全局水平（均值）以及与该水平的平均偏差（方差）保持不变，那么该序列是稳定的。

&emsp;&emsp; 尽管多数令人感兴趣的序列都不稳定，但只要能够通过应用变换（如，自然对数、差分或季节差分）使序列保持稳定，那么 ARIMA 就是有效的。

&emsp;&emsp; **方差稳定变换**。方差随时间变化的序列通常可以使用自然对数变换或平方根变换来保持稳定。这些变换也称为函数变换。

&emsp;&emsp; - 自然对数。对序列值取自然对数。

&emsp;&emsp; - 平方根。对序列值应用平方根函数。

&emsp;&emsp; 自然对数变换和平方根变换不能用于具有负值的序列。

&emsp;&emsp; **水平稳定变换**。ACF 中值的缓慢下降表示每个序列值都与上一个值具有很强的相关性。通过分析序列值的变化，您可以获得一个稳定水平。

&emsp;&emsp; - 简单差分。计算序列中每个值与上一个值之间的差，序列中最旧的值除外。这意味着经过差分的序列将比原始序列少一个值。

&emsp;&emsp; - 季节性差分。除计算每个值与上一个季节值之间的差值外，其他均与简单差分相同。

&emsp;&emsp; 将简单差分或季节差分同时用于对数变换或平方根变换时，总是先应用方差稳定变换。同时使用简单差分和季节差分时，无论首先应用简单差分还是季节差分，得到的序列值均相同。

<br>

## 3. 自相关函数和偏自相关函数

### 3.1 自相关函数和偏自相关函数的介绍

&emsp;&emsp;自相关和偏自相关用于测量当前序列值和过去序列值之间的相关性，并指示预测将来值时最有用的过去序列值。了解了此内容，您就可以确定 ARIMA 模型中过程的顺序。更具体来说，

&emsp;&emsp;自相关函数 (ACF)。延迟为 k 时，这是相距 k 个时间间隔的序列值之间的相关性。

&emsp;&emsp;偏自相关函数 (PACF)。延迟为 k 时，这是相距 k 个时间间隔的序列值之间的相关性，同时考虑了间隔之间的值。

![](https://www.ibm.com/support/knowledgecenter/zh/SS3RA7_sub/modeler_mainhelp_client_ddita/components/images/ex5_sv4.jpg)

&emsp;&emsp;ACF 图的 x 轴表示计算自相关处的延迟； y 轴表示相关值（介于 −1 和 1 之间）。例如，ACF 图中延迟 1 处的峰值表示每个序列值与前面的值强相关，延迟 2 处的峰值表示每个值与以前两个点之间的值强相关，依此类推。

&emsp;&emsp;- 正相关表示较大的当前值与指定延迟处较大的值相对应；负相关表示较大的当前值与指定延迟处较小的值相对应。

&emsp;&emsp;- 相关的绝对值是关联强度的测量，绝对值越大表明关系越强。

#### 3.2 自相关函数

&emsp;&emsp;其实自相关系数可以这么理解：把一列数据按照滞后数拆成两列数据，在对这两列数据做类似相关系数的操作。

&emsp;&emsp;看一个例子：

![](https://pic1.zhimg.com/80/v2-5ea1e372439d74c9853d0e155db613c4_hd.png)

&emsp;&emsp;这组数据是求滞后数为2的自相关系数，则变成求{x1,x2,...,x8}和{x3,x4,...,x10}两者的“相关系数”，相关系数打引号是因为这个相关系数的公式和以往的有点不一样。下面看一下公式的对比：

![](https://pic3.zhimg.com/80/v2-854c22d804d6cfcdeab6f01317cb000a_hd.jpg)

&emsp;&emsp;要注意的是在计算自相关系数的时候 u 是使用的总体的均值, 可以看到他们除了 u 取得不一样, 几乎就是一样的。

&emsp;&emsp;u代表下面图片所示符号(不知道在知乎怎么打出这个符号来)

![](https://pic3.zhimg.com/80/v2-f1d499be0a93ca2382a23b2308d34e8e_hd.jpg)

&emsp;&emsp;所以，我们可以这么理解自相关系数, 她就是用来表达一组数据前后数据 (自己和自己) 的相关性的

&emsp;&emsp;在statsmodels中，可以使用acf来求解：

```python
from statsmodels.tsa.stattools import pacf

lag_acf = acf(ts_log_diff, nlags = 20)
```

#### 3.3 偏自相关函数

&emsp;&emsp;定义：

![](https://pic1.zhimg.com/80/v2-1168f8ebcf61bff7013bbc610abc34d4_hd.png)

&emsp;&emsp;可以看到偏自相关系数就是去掉一些变量的影响后再来考察自相关系数。

![](https://pic3.zhimg.com/80/v2-57a4ecb9466e859ea8f84e3c010e283e_hd.png)

&emsp;&emsp;在statsmodels中，可以使用pacf来求解：

```python
from statsmodels.tsa.stattools import pacf

lag_pacf = pacf(ts_log_diff, nlags = 20)
```

### 3.4 ACF和PACF的应用

&emsp;&emsp;时间序列的自回归函数和部分自回归函数可以在差分后绘制为：

```python
#ACF and PACF plots:
from statsmodels.tsa.stattools import acf, pacf
 
lag_acf = acf(ts_log_diff, nlags=20)
lag_pacf = pacf(ts_log_diff, nlags=20, method='ols')
 
#Plot ACF: 
plt.subplot(121) 
plt.plot(lag_acf)
plt.axhline(y=0,linestyle='--',color='gray')
plt.axhline(y=-1.96/np.sqrt(len(ts_log_diff)),linestyle='--',color='gray')
plt.axhline(y=1.96/np.sqrt(len(ts_log_diff)),linestyle='--',color='gray')
plt.title('Autocorrelation Function')
 
#Plot PACF:
plt.subplot(122)
plt.plot(lag_pacf)
plt.axhline(y=0,linestyle='--',color='gray')
plt.axhline(y=-1.96/np.sqrt(len(ts_log_diff)),linestyle='--',color='gray')
plt.axhline(y=1.96/np.sqrt(len(ts_log_diff)),linestyle='--',color='gray')
plt.title('Partial Autocorrelation Function')
plt.tight_layout()
```

![](https://camo.githubusercontent.com/6cca563df21372898b267cec405150ae4b590980/68747470733a2f2f7777772e6269616f6469616e66752e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031382f31312f61662d7061662e706e67)

&emsp;&emsp;在ARIMA模型中，可根据ACF、PACF函数图来确定“p”和“q”的值。

&emsp;&emsp;p-部分自相关函数表第一次截断的上层置信区间是滞后值。如果你仔细看，该值是p=0。

&emsp;&emsp;q-自相关函数表第一次截断的上层置信区间是滞后值。如果你仔细看，该值是q=1。


#### 3.4.2 利用ACF、PACF图确定是AR还是MA过程：

对于主要是AR过程，在移动平均序列的滞后n中，x(t)与x(t-n-1)之间不存在任何相关，PACF图会在第n次滞后处截止。而ACF图中相关性是逐渐下降的。

如下图主要是AR过程：

![](https://upload-images.jianshu.io/upload_images/10947003-23e3f32f0b310dab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

对于主要是MA过程，在移动平均序列的滞后n中，x(t)与x(t-n-1)之间不存在任何相关，ACF图会在第n次滞后处截止。而PACF图中相关性是逐渐下降的。

如下图主要是MA过程：

![](https://upload-images.jianshu.io/upload_images/10947003-2042690d715a1b97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)





<br>
<br>
<br>
<br>


## Reference：

1. [自相关函数和偏自相关函数](https://www.ibm.com/support/knowledgecenter/zh/SS3RA7_sub/modeler_mainhelp_client_ddita/components/dt/timeseries_acf_pacf.html)

2. [[时间序列分析][3]--自相关系数和偏自相关系数](https://zhuanlan.zhihu.com/p/26525852)

3. [时间序列建模完整教程（R语言）](https://www.biaodianfu.com/complete-tutorial-time-series-modeling.html)