


1. 现有一个会议室预定系统，包含如下表实体：用户表（用户id，用户名，部门，职位）；会议室表（会议室id，办公楼编号，楼层，会议室门牌，会议室类型id）；会议室类型（类型id，容纳人数，是否有投影仪，是否有电话，是否有视频电话）；会议订阅表（用户id，会议室id，订阅开始时间，订阅结束时间）

a. 请根据以上表结构写出建表的sql语句，注意选择合适的字段类型和主键。

b. 有需求查出2017-09-11 10:00:00 至 2017-09-11 12:00:00没有被人预定过的会议室id列表，要求容纳人数在10人以上，有投影仪和视频电话。请问这个sql语句如何编写，如何添加索引加速这个查下。

c. 假设订阅一个会议室包括两个步骤：1.查询出可以预定的会议室列表。2.插入会议订阅表（包含订阅的时间和用户id，会议室id）表示预定。请问如果两个用户同时预定，如何利用数据库的特性保障这两个用户不会在同一时间段预定同一个会议室。

a.
```sql
CREATE TABLES users(
  user_id INT NOT NULL AUTO_INCREMENT,
  user_name VARCHAR(30) NOT NULL,
  dept  VARCHAR(30) NOT NULL,
  job VARCHAR(30) NOT NULL,
  PRIMARY KEY (user_id)
)

CREATE TABLES meeting_rooms(
  meeting_room_id INT NOT NULL AUTO_INCREMENT,
  office_building INT NOT NULL,
  storey INT NOT NULL,
  doorplate VARCHAR(20) NOT NULL,
  meeting_room_type_id INT NOT NULL,
  PRIMARY KEY (meeting_room_id),
  FOREIGN KEY (meeting_room_type_id) REFERENCES meeting_room_types(meeting_room_type_id)
)

CREATE TABLES meeting_room_types(
  meeting_room_type_id INT AUTO_INCREMENT,
  people_num INT NOT NULL,
  projector BOOLEAN NOT NULL,
  telephone BOOLEAN NOT NULL,
  video_telephone BOOLEAN NOT NULL,
  PRIMARY KEY (meeting_room_type_id)
)

CREATE TABLES meeting_orders(
  user_id INT NOT NULL,
  meeting_room_id INT NOT NULL,
  start_time DATETIME NOT NULL,
  end_time DATETIME NOT NULL
  PRIMARY KEY(user_id, meeting_room_id)
)

```

b. 
```sql
SELECT
  t1.meeting_room_id
FROM
  (meeting_rooms AS t1 LEFT OUTER JOIN meeting_room_types AS t2 ON t1.meeting_room_type_id = t2.meeting_room_type_id) LEFT OUTER JOIN meeting_orders AS t3 ON t1.meeting_room_id = t2.meeting_room_id
WHERE
  t2.people_num > 10
  AND t2.projector = TRUE
  AND t2.video_telephone = TRUE
  AND t3.start_time NOT BETWEEN '2017-09-11 10:00:00' AND '2017-09-11 12:00:00'
  AND t3.end_time NOT BETWEEN '2017-09-11 10:00:00' AND '2017-09-11 12:00:00';
```

为了提高查询速度，可以考虑在meeting_orders表上，对start_time和end_time字段添加索引；

c.利用数据库中的共享锁和排他锁，用户对会议顶订阅表进行查询时，该事务对表添加共享锁，使得其他用户只能读取该表不能进行其他操作。当用户对会议订阅表进行修改时，该事务对会议订阅表添加排他锁，只允许当前用户的修改操作，不允许其他操作。